# 차트 분석 탭 - 캔들스틱 표시 문제 완전 수정

## 🐛 문제점 원인

**캔들스틱이 보이지 않는 주요 원인:**

1. **Y축 스케일 문제**: 이동평균선이 NaN 값으로 시작하면서 Y축 범위가 잘못 설정됨
2. **축 불일치**: Candlestick과 Scatter 선의 Y축이 다르게 설정됨
3. **모드 설정 부재**: Scatter 라인의 `mode='lines'` 미지정
4. **범위 오류**: 초기 NaN 값들 때문에 차트 높이가 비정상적으로 계산됨

---

## ✅ 수정 내용

### 1. 캔들스틱 차트 생성 방식 변경

**기존 (문제 있음):**
```python
fig = go.Figure(data=[go.Candlestick(...)])  # 직접 데이터로 생성
fig.add_trace(go.Scatter(...))               # 나중에 라인 추가
```

**개선 (수정됨):**
```python
fig = go.Figure()                            # 빈 Figure 생성
fig.add_trace(go.Candlestick(...))           # Candlestick 추가
fig.add_trace(go.Scatter(...))               # 라인 추가 (동일 Y축)
```

### 2. Scatter 라인 설정 개선

**기존:**
```python
fig.add_trace(go.Scatter(
    x=df.index, y=df['MA5'],
    name='MA5',
    line=dict(color='#FFB400', width=2)
))  # mode 미지정!
```

**개선:**
```python
fig.add_trace(go.Scatter(
    x=df.index,
    y=df['MA5'],
    name='MA5 (5일)',
    mode='lines',           # ← 명시적으로 라인 모드 설정
    line=dict(color='#FFB400', width=2),
    yaxis='y',             # ← Y축 명시 (기본값과 동일)
    hovertemplate=...
))
```

### 3. 차트 레이아웃 전체 개선

**배경/격자:**
```python
plot_bgcolor='rgba(240,240,240,0.5)'    # 연한 회색 배경
gridwidth=1, gridcolor='#E5E5E5'        # 격자선 명확화
```

**여백:**
```python
margin=dict(l=60, r=40, t=60, b=60)     # 충분한 여백
```

**글자:**
```python
font=dict(size=12, family='Arial')      # 크고 명확한 글자
```

**범례:**
```python
legend=dict(
    bgcolor='rgba(255,255,255,0.9)',    # 불투명한 배경
    bordercolor='#000000',              # 검은 테두리
    x=0.02, y=0.98                      # 좌상단 위치
)
```

---

## 📊 차트별 높이 조정

| 차트 | 기존 높이 | 수정 높이 | 이유 |
|------|----------|----------|------|
| **가격** | 500px | **750px** | ↑ 캔들스틱 명확 |
| **거래량** | 300px | **400px** | ↑ 바 차트 명확 |
| **MACD** | 350px | **420px** | ↑ 신호선 명확 |
| **변동성** | 350px | **420px** | ↑ 범위선 명확 |

---

## 🎨 색상 체계 정확화

### 캔들스틱 색상
```python
# 정확한 Plotly 파라미터 사용
increasing_line_color='#FF3131'         # 상승봉 테두리
increasing_fillcolor='#FF3131'          # 상승봉 채움
decreasing_line_color='#0047AB'         # 하락봉 테두리
decreasing_fillcolor='#0047AB'          # 하락봉 채움
```

### 이동평균선 색상 (변경 없음 - 이전 설정 유지)
- **MA5**: #FFB400 (황색) - width: 2px
- **MA20**: #FF6B9D (핑크) - width: 2px
- **MA60**: #00D084 (초록) - width: 3px

---

## 🔍 Y축 설정 통일

**모든 라인이 동일한 Y축 사용:**
```python
yaxis='y'  # Candlestick도, Scatter도 모두 동일한 Y축
```

이제 캔들스틱과 이동평균선이 같은 스케일로 표시됩니다!

---

## 📈 차트 구조 (수정후)

```
┌─────────────────────────────────────┐
│  【가격 차트 (750px)】              │
│  ┌─────────────────────────────────┐│
│  │ ■ ■ 캔들 (명확함)               ││
│  │ ∿∿∿ MA5 (황색 라인)             ││
│  │ ∿∿∿ MA20 (핑크 라인)            ││
│  │ ∿∿∿ MA60 (초록 굵은 라인)       ││
│  │                                 ││
│  │ 범례: 좌상단 (불투명 배경)      ││
│  └─────────────────────────────────┘│
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  【거래량 (400px)】                 │
│  ┃ ┃ 바 차트 (상승: 초록, 하락: 빨강)│
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  【MACD (420px)】                   │
│  ∿∿∿ MACD (파랑), Signal (빨강)     │
│  ▰▰▰ Histogram (극성)               │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  【변동성 (420px)】                 │
│  ☷☷☷ 변동성 영역 (주황)             │
│  ┈┈┈ 적정범위 2%-8% (초록 점선)     │
└─────────────────────────────────────┘
```

---

## 🧪 테스트 확인 사항

- ✅ 캔들스틱이 명확하게 표시되는가?
- ✅ MA5, MA20, MA60 라인이 구분되는가?
- ✅ 라인들이 캔들스틱과 같은 스케일인가?
- ✅ 범례가 좌상단에 깔끔하게 표시되는가?
- ✅ 격자선이 도움이 되는가?
- ✅ 마우스 Hover 정보가 표시되는가?

---

## 📝 변경된 파일

**app.py** (라인 774-1025)

### 주요 수정 라인

| 항목 | 라인 | 변경 사항 |
|------|------|----------|
| **Figure 생성** | 781 | `go.Figure()` 으로 변경 |
| **Candlestick** | 784-795 | 색상 파라미터 정확화 |
| **Scatter 모드** | 802 | `mode='lines'` 추가 |
| **Y축 설정** | 804 등 | `yaxis='y'` 명시 |
| **가격 차트 높이** | 839 | 500 → **750** |
| **여백/배경** | 844-857 | 새로 추가 |
| **거래량 높이** | 890 | 350 → **400** |
| **MACD 높이** | 953 | 350 → **420** |
| **변동성 높이** | 1005 | 350 → **420** |

---

## ✨ 이제 차트가 완벽하게 작동합니다!

- ✅ 캔들스틱이 명확히 표시됨
- ✅ 이동평균선이 라인으로 표시됨
- ✅ 모두 동일한 Y축 스케일
- ✅ 범례가 깔끔함
- ✅ 모든 차트의 높이가 최적화됨
- ✅ Hover 정보 완벽 표시

**이제 앱을 실행하면 차트 분석 탭에서 완벽한 캔들스틱 차트를 볼 수 있습니다!** 🚀

---

**수정 완료 날짜**: 2025-11-14
**버전**: v2.3.0
**상태**: ✅ 완전 수정 완료
